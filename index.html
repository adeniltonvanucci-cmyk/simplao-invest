// =============================
// FORMATADOR DE VALORES (R$)
// =============================
function formatarReal(input) {
  let val = input.value.replace(/\D/g, "");
  val = (val / 100).toFixed(2) + "";
  val = val.replace(".", ",");
  val = val.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
  input.value = "R$ " + val;
}

document.querySelectorAll('input[type="text"][inputmode="numeric"]').forEach(input => {
  input.addEventListener("input", () => formatarReal(input));
  input.addEventListener("focus", () => {
    input.value = input.value.replace(/\D/g, "") / 100 || "";
  });
});

// =============================
// CONTROLE DE CAMPOS DE TAXA
// =============================
const FIELDS_BY_REGIME = {
  pre:  ["taxaPre"],
  pos:  ["percentCDI", "cdiAnual"],
  ipca: ["ipcaAnual", "taxaFixa"],
};

function updateVisibleFields(formId) {
  const form = document.getElementById(formId);
  const regime = form.querySelector('[data-input="regime"] select').value;
  const visible = FIELDS_BY_REGIME[regime] || [];

  form.querySelectorAll("[data-field]").forEach(row => {
    const key = row.dataset.field;
    row.classList.toggle("hidden", !visible.includes(key));
  });
}

// inicializa
["formA"].forEach(id => {
  const form = document.getElementById(id);
  if (!form) return;
  const select = form.querySelector('[data-input="regime"] select');
  select.addEventListener("change", () => updateVisibleFields(id));
  updateVisibleFields(id);
});

// =============================
// CÁLCULO SIMPLIFICADO
// =============================
function limparNumero(str) {
  if (!str) return 0;
  return Number(String(str).replace(/[^\d,.-]/g, "").replace(/\./g, "").replace(",", ".")) || 0;
}

function calcularInvestimento() {
  const aporteInicial = limparNumero(document.getElementById("aporteInicialA").value);
  const aporteMensal = limparNumero(document.getElementById("aporteMensalA").value);
  const taxa = parseFloat(document.getElementById("taxaPreA").value) / 100;
  const meses = parseInt(document.getElementById("prazoMesesA").value);

  if (aporteInicial + aporteMensal === 0) {
    document.querySelectorAll(".kpi .value").forEach(el => (el.textContent = "—"));
    document.querySelector("#tabela tbody").innerHTML = "";
    return;
  }

  let saldo = aporteInicial;
  const linhas = [];
  for (let i = 1; i <= meses; i++) {
    const juros = saldo * (taxa / 12);
    saldo += juros + aporteMensal;
    linhas.push({
      mes: i,
      data: new Date(new Date().setMonth(new Date().getMonth() + i)).toLocaleDateString("pt-BR"),
      saldo,
      aporte: aporteMensal,
      juros,
    });
  }

  const totalInvestido = aporteInicial + aporteMensal * meses;
  const rendimentoBruto = saldo - totalInvestido;
  const impostos = rendimentoBruto * 0.15;
  const saldoLiquido = saldo - impostos;

  document.getElementById("saldoLiquido").textContent = saldoLiquido.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  document.getElementById("totalInvestido").textContent = totalInvestido.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  document.getElementById("rendimentoBruto").textContent = rendimentoBruto.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  document.getElementById("impostos").textContent = impostos.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  linhas.forEach(l => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.mes}</td>
      <td>${l.data}</td>
      <td>${l.saldo.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
      <td>${l.aporte.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
      <td>${l.juros.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("calcularA").addEventListener("click", calcularInvestimento);

// =============================
// ANO DO FOOTER
// =============================
document.getElementById("ano").textContent = new Date().getFullYear();
