<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Metadados SEO e sociais -->
  <!-- SEO básico -->
<title>Simplão Invest • Amortização de Financiamentos</title>
<meta name="description" content="Simule financiamentos com tabelas SAC e Price. Compare parcelas, juros e saldo devedor.">
<meta name="keywords" content="simulador de amortização, tabela SAC, tabela Price, financiamento, empréstimo, cálculo de parcelas, saldo devedor">
<meta name="robots" content="index, follow">
<meta name="author" content="Simplão Invest">

<!-- Open Graph (Facebook, LinkedIn, WhatsApp) -->
<meta property="og:title" content="Simulador de Amortização • Simplão Invest">
<meta property="og:description" content="Compare SAC e Price e veja como evoluem as parcelas e os juros do seu financiamento.">
<meta property="og:url" content="https://www.calcularinvestimento.com.br/amortizacao.html">
<meta property="og:image" content="https://www.calcularinvestimento.com.br/logo.png">
<meta property="og:type" content="website">
<meta property="og:locale" content="pt_BR">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Simulador de Amortização • Simplão Invest">
<meta name="twitter:description" content="Compare SAC e Price e veja como evoluem as parcelas e os juros do seu financiamento.">
<meta name="twitter:image" content="https://www.calcularinvestimento.com.br/logo.png">

  <style>
    /* seu CSS continua aqui */
  </style>
</head>
 
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simplão Invest • Amortização de Financiamentos</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--line:#1f2937;--primary:#2563eb;--primary-700:#1d4ed8;--radius:14px}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Roboto,Arial,sans-serif}
    .container{max-width:1180px;margin:0 auto;padding:18px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;object-fit:contain}
    h1{font-size:1.4rem;margin:0}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:.95rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01) 60%);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-weight:600;font-size:.92rem}
    input,select,button{width:100%;background:#0b1220;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:10px 12px;font-size:.97rem;outline:none}
    input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
    .row{margin-bottom:12px}
    .row.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:linear-gradient(90deg,var(--primary),var(--primary-700));color:#fff;border:0;border-radius:12px;padding:11px 16px;font-weight:800;cursor:pointer;margin-top:4px}
    .btn.secondary{background:#0b1220;border:1px solid var(--line);font-weight:700}
    .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .metric{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px}
    .metric .label{color:var(--muted);font-size:.82rem}
    .metric .value{font-weight:800;font-size:1.08rem;margin-top:3px}
    .table-wrap{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220;margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    thead th{background:#0f172a;color:#cbd5e1;position:sticky;top:0;z-index:1;padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody{display:block;max-height:480px;overflow:auto}
    thead,tbody tr{display:table;width:100%;table-layout:fixed}
    .foot{display:flex;gap:12px;flex-wrap:wrap}
    .note{font-size:.85rem;color:var(--muted)}
    canvas{width:100%;height:260px;background:#0b1220;border:1px solid var(--line);border-radius:12px}

    /* PRINT para PDF */
    @media print{
      body{background:#fff;color:#000}
      .card, .table-wrap, canvas{border-color:#ccc}
      .header, .card, .table-wrap{break-inside:avoid}
      .no-print{display:none !important}
      .print-header{display:block;margin-bottom:12px;border-bottom:1px solid #ccc;padding-bottom:8px}
      .print-header small{color:#333}
      .grid{grid-template-columns:1fr}
    }
    .print-header{display:none}
    .tag{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px dashed var(--line);border-radius:999px;color:var(--muted);font-size:.85rem}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#0b1220;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:.85rem}
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand">
      <img class="logo" alt="logo" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4b0.svg"/>
      <div>
        <h1>Amortização de Financiamentos - www.calcularinvestimento.com.br</h1>
        <p class="subtitle">PRICE e SAC, taxa a.a./a.m., amortizações por data e extra mensal, exportação CSV e PDF.</p>
      </div>
    </div>
  </header>

  <main class="container grid">
    <!-- COLUNA ESQUERDA: FORM -->
    <section class="card">
      <form id="amortForm">
        <div class="row two">
          <div>
            <label for="principal">Valor financiado (R$)</label>
            <input id="principal" placeholder="R$ 300.000,00" inputmode="numeric" />
          </div>
          <div>
            <label for="periodo">Prazo (meses)</label>
            <input id="periodo" placeholder="360" inputmode="numeric" />
          </div>
        </div>
      
<!-- Campo de taxa de juros -->
<div class="row two">
  <div>
    <label for="tipoTaxa">Tipo da taxa</label>
    <select id="tipoTaxa">
      <option value="aa" selected>Anual % (a.a)</option>
      <option value="am">Mensal % (a.m)</option>
    </select>
  </div>
  <div>
    <label for="rate">Taxa de juros</label>
    <input id="rate" placeholder="Ex: 9.8788" inputmode="0,0000" />
  </div>
</div>

<!-- Script para tratar entrada -->
<script>
  document.getElementById("rate").addEventListener("change", function (e) {
    let valorDigitado = e.target.value.trim().replace(",", ".");
    let taxa = parseFloat(valorDigitado);

    if (isNaN(taxa)) {
      alert("Por favor, insira uma taxa válida (ex: 9.8788)");
      e.target.focus();
    } else {
      console.log("Taxa registrada:", taxa);
      // Aqui você pode usar a taxa para cálculos ou enviar ao servidor
    }
  });
</script>

        <div class="row two">
          <div>
            <label for="sistema">Sistema</label>
            <select id="sistema">
              <option value="price">PRICE</option>
              <option value="sac">SAC</option>
            </select>
          </div>
          <div>
            <label for="dataInicio">Data do 1º vencimento</label>
            <input id="dataInicio" type="date" />
          </div>
        </div>

        <!-- Novo: Extra mensal fixo -->
        <div class="row">
          <label for="extraMensal">Extra mensal fixo (R$) — opcional</label>
          <input id="extraMensal" placeholder="R$ 100,00" inputmode="numeric" />
        </div>

        <!-- Amortizações extras por DATA, múltiplas entradas -->
        <div class="row">
          <label>Amortizações extras por data</label>
          <div class="tag">Requer informar a Data do 1º vencimento</div>
          <div class="row two">
            <input id="extraValor" placeholder="R$ 10.000,00" inputmode="numeric" />
            <input id="extraData" type="date" />
          </div>
          <div class="foot">
            <button class="btn secondary" id="addExtra" type="button">Adicionar amortização</button>
            <div class="chips" id="extrasChips"></div>
          </div>
        </div>

        <div class="row">
          <label for="seguroTaxa">Seguro/tarifas mensais (R$) — opcional</label>
          <input id="seguroTaxa" placeholder="R$ 0,00" inputmode="numeric" />
        </div>

        <button class="btn" type="submit">Calcular</button>
      </form>
    </section>

    <!-- COLUNA DIREITA: RESULTADOS -->
    <section class="card">
      <div class="metrics" id="resumo">
        <div class="metric"><div class="label">Prestação inicial</div><div class="value" id="prestacaoIni">—</div></div>
        <div class="metric"><div class="label">Total pago</div><div class="value" id="totalPago">—</div></div>
        <div class="metric"><div class="label">Total juros</div><div class="value" id="totalJuros">—</div></div>
        <div class="metric"><div class="label">Meses quitados</div><div class="value" id="mesesQuitados">—</div></div>
      </div>
      <canvas id="grafico"></canvas>
      <div class="foot">
        <button class="btn" id="baixarCsv" type="button">Baixar CSV</button>
        <button class="btn" id="copiarLink" type="button">Copiar link</button>
        <button class="btn" id="baixarPdf" type="button">Exportar PDF</button>
      </div>
      <p class="note">O gráfico resume por ano a composição Juros × Amortização (somatórios anuais).</p>
    </section>

    <!-- TABELA COMPLETA -->
    <section class="card" style="grid-column:1/-1">
      <h2 style="margin:0 0 8px">Cronograma de amortização</h2>
      <div class="table-wrap">
        <table id="tabela">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Data</th>
              <th>Prestação (R$)</th>
              <th>Amortização (R$)</th>
              <th>Juros (R$)</th>
              <th>Seguro/Taxas (R$)</th>
              <th>Extra (R$)</th>
              <th>Saldo Devedor (R$)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="container" style="text-align:center;color:var(--muted);margin:16px 0 10px">
    <div class="no-print" style="margin-bottom:12px;">
      <button class="btn secondary" onclick="window.location.href='index.html'">⬅️ Voltar à Página Inicial</button>
    </div>

    <div class="print-header">
      <strong>Simplão Invest — Simulação de Amortização</strong><br/>
      <small>Origem: https://www.calcularinvestimento.com.br • Contato: contato@calcularinvestimento.com.br</small>
    </div>
    <p>© <span id="ano"></span> Simplão Invest • Ferramentas gratuitas para decisões financeiras melhores.</p>
  </footer>

  <script>
    // ===================== Utilidades BR =====================
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const fmtDate = (d) => new Intl.DateTimeFormat('pt-BR', { timeZone:'UTC' }).format(d);
    function parseBRNumber(str){ if(str==null) return 0; const s=String(str).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'); const v=parseFloat(s); return isNaN(v)?0:v; }

    function attachBRLMask(el){ if(!el) return; el.addEventListener('input',()=>{ let dg=el.value.replace(/\D/g,''); if(!dg){el.value='';return;} dg=dg.substring(0,13); const val=(parseInt(dg,10)/100).toFixed(2); el.value=fmtBRL.format(val); }); el.addEventListener('focus',()=>{ if(!el.value) el.value='R$ 0,00'; }); el.addEventListener('blur',()=>{ const v=parseBRNumber(el.value); el.value=v===0?'':fmtBRL.format(v); }); }
    function attachPercentMask(el){ if(!el) return; el.addEventListener('input',()=>{ let dg=el.value.replace(/\D/g,''); if(!dg){el.value='';return;} dg=dg.substring(0,5); const val=(parseInt(dg,10)/100).toFixed(2); el.value=String(val).replace('.', ','); }); el.addEventListener('blur',()=>{ const v=parseBRNumber(el.value); el.value=v===0?'':String(v.toFixed(2)).replace('.', ','); }); }

    // ===================== Cálculos =====================
    function mensalDeAnual(aa){ const a=(aa||0)/100; return Math.pow(1+a, 1/12)-1; }
    function pmtPrice(P, i, n){ if(i===0) return P/n; const f = Math.pow(1+i,n); return P * (i*f)/(f-1); }

    function monthIndexFromDate(startUTC, whenUTC){
      const y1=startUTC.getUTCFullYear(), m1=startUTC.getUTCMonth();
      const y2=whenUTC.getUTCFullYear(), m2=whenUTC.getUTCMonth();
      return (y2 - y1)*12 + (m2 - m1) + 1; // meses iniciam em 1
    }

    function gerarCronograma({principal, iMes, nMeses, sistema, extras, extraMensal, seguroTaxa, data0}){
      const linhas=[]; let saldo = principal; let prestacaoFixa = 0; let totalJuros=0; let totalPago=0; let mesesExecutados=0;

      if(sistema==='price') prestacaoFixa = Math.round(pmtPrice(principal, iMes, nMeses)*100)/100;
      const amortConstante = sistema==='sac' ? Math.round((principal/nMeses)*100)/100 : 0;

      const extrasPorMes = {};
      (extras||[]).forEach(ex=>{ const k = ex.mes; extrasPorMes[k] = (extrasPorMes[k]||0) + ex.valor; });

      for(let m=1; m<=nMeses && saldo>0.005; m++){
        const data = data0 ? new Date(Date.UTC(data0.getUTCFullYear(), data0.getUTCMonth()+m-1, data0.getUTCDate())) : null;
        const juros = Math.round((saldo*iMes)*100)/100;
        let amort = 0, prest = 0, taxas = Math.round(seguroTaxa*100)/100;

        if(sistema==='price'){
          prest = (prestacaoFixa + taxas);
          amort = Math.min(prestacaoFixa - juros, saldo);
        } else {
          amort = Math.min(amortConstante, saldo);
          prest = amort + juros + taxas;
        }

        // somatório de extras: por data + mensal fixo
        const extraAlvo = (extrasPorMes[m]||0) + (extraMensal||0);
        let extra = Math.min(Math.round(extraAlvo*100)/100, Math.max(0, saldo - amort));

        const pagoNoMes = prest + extra;
        saldo = Math.max(0, Math.round((saldo - amort - extra)*100)/100);
        totalJuros += juros; totalPago += pagoNoMes; mesesExecutados = m;

        linhas.push({
          mes:m,
          data:data?fmtDate(data):'—',
          prestacao:prest,
          amortizacao:amort,
          juros:juros,
          taxas:taxas,
          extra:extra,
          saldo:saldo
        });

        if(saldo<=0.005) break;
      }
      return {linhas,totalJuros:Math.round(totalJuros*100)/100,totalPago:Math.round(totalPago*100)/100,mesesExecutados};
    }

    // ===================== Gráfico anual (Canvas 2D) =====================
    function desenharGraficoAnual(canvas, linhas, data0){
      const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.clientWidth * devicePixelRatio;
      const H = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,W,H);
      if(!linhas.length) return;

      const series = {};
      linhas.forEach((l,idx)=>{
        let ano = 'Sem data';
        if(data0){ const d = new Date(Date.UTC(data0.getUTCFullYear(), data0.getUTCMonth()+idx, data0.getUTCDate())); ano = d.getUTCFullYear(); }
        series[ano] = series[ano] || {juros:0, amort:0};
        series[ano].juros += l.juros;
        series[ano].amort += (l.amortizacao + l.extra);
      });
      const anos = Object.keys(series).map(a=>String(a));
      const maxV = Math.max(1, ...anos.map(a=>series[a].juros+series[a].amort));

      const padL=50*devicePixelRatio, padB=28*devicePixelRatio, padT=20*devicePixelRatio, barW = Math.max(14*devicePixelRatio, (W - padL - 20*devicePixelRatio)/(anos.length*1.8));
      const usableW = W - padL - 20*devicePixelRatio, usableH = H - padT - padB;

      ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1*devicePixelRatio;
      ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.lineTo(W-20*devicePixelRatio, H-padB); ctx.stroke();

      anos.forEach((a, i)=>{
        const x = padL + (i+0.5)*(usableW/anos.length);
        const hA = (series[a].amort/maxV)*usableH;
        const hJ = (series[a].juros/maxV)*usableH;
        ctx.fillStyle = '#22d3ee';
        ctx.fillRect(x-barW/2, H-padB-hA, barW, hA);
        ctx.fillStyle = '#94a3b8';
        ctx.fillRect(x-barW/2, H-padB-hA-hJ, barW, hJ);
        ctx.fillStyle = '#cbd5e1';
        ctx.textAlign = 'center'; ctx.textBaseline = 'top'; ctx.font = `${12*devicePixelRatio}px sans-serif`;
        ctx.fillText(a, x, H-padB+6*devicePixelRatio);
      });
    }

    // ===================== CSV, Link e PDF =====================
    function toCSV(linhas){
      const header = ['Mes','Data','Prestacao','Amortizacao','Juros','Taxas','Extra','Saldo'];
      const rows = linhas.map(l=>[l.mes,l.data, l.prestacao.toFixed(2), l.amortizacao.toFixed(2), l.juros.toFixed(2), l.taxas.toFixed(2), l.extra.toFixed(2), l.saldo.toFixed(2)]);
      const csv = [header.join(';')].concat(rows.map(r=>r.join(';'))).join('\n');
      return new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
    }
    function copiarLink(params){
      const url = new URL(location.href);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, String(v)));
      navigator.clipboard.writeText(url.toString());
      alert('Link copiado!');
    }
    function exportarPDF(){ window.print(); }

    // ===================== Controle da UI =====================
    const $ = (sel)=>document.querySelector(sel);
    const el = {
      form: $('#amortForm'), principal: $('#principal'), periodo: $('#periodo'), sistema: $('#sistema'), tipoTaxa: $('#tipoTaxa'), dataInicio: $('#dataInicio'), rate: $('#rate'),
      extraMensal: $('#extraMensal'),
      extraValor: $('#extraValor'), extraData: $('#extraData'), addExtra: $('#addExtra'), extrasChips: $('#extrasChips'),
      seguroTaxa: $('#seguroTaxa'),
      prestacaoIni: $('#prestacaoIni'), totalPago: $('#totalPago'), totalJuros: $('#totalJuros'), mesesQuitados: $('#mesesQuitados'), tabela: $('#tabela tbody'), grafico: $('#grafico'), baixarCsv: $('#baixarCsv'), copiarLink: $('#copiarLink'), baixarPdf: $('#baixarPdf')
    };

    ['#principal','#seguroTaxa','#extraValor','#extraMensal'].forEach(sel=> attachBRLMask($(sel)) );
    attachPercentMask(el.rate);

    const extras = []; // {valor:number, data:Date, mes:int}

    function renderExtrasChips(){
      el.extrasChips.innerHTML = '';
      extras.sort((a,b)=>a.mes-b.mes).forEach((ex, idx)=>{
        const chip = document.createElement('span'); chip.className='chip';
        chip.textContent = `${fmtDate(ex.data)} • ${fmtBRL.format(ex.valor)}`;
        chip.title = 'Clique para remover';
        chip.style.cursor='pointer';
        chip.onclick = ()=>{ extras.splice(idx,1); renderExtrasChips(); };
        el.extrasChips.appendChild(chip);
      });
    }

    el.addExtra.onclick = ()=>{
      const v = parseBRNumber(el.extraValor.value);
      const dStr = el.extraData.value;
      if(!(v>0) || !dStr){ alert('Informe valor e data da amortização.'); return; }
      if(!el.dataInicio.value){ alert('Defina a Data do 1º vencimento antes de adicionar amortizações.'); return; }
      const [Y,M,D] = dStr.split('-').map(Number); const d = new Date(Date.UTC(Y,M-1,D));
      const [Y0,M0,D0] = el.dataInicio.value.split('-').map(Number); const d0 = new Date(Date.UTC(Y0,M0-1,D0));
      const mes = monthIndexFromDate(d0, d);
      if(mes < 1){ alert('A data da amortização deve ser no mesmo mês do 1º vencimento ou após.'); return; }
      extras.push({valor:v, data:d, mes});
      el.extraValor.value=''; el.extraData.value='';
      renderExtrasChips();
    };

    function lerDoQuery(){
      const url = new URL(location.href); const get=(k,d='')=> url.searchParams.get(k) ?? d;
      el.principal.value = get('p',''); el.rate.value = get('i',''); el.periodo.value = get('n',''); el.sistema.value = get('sys','price'); el.tipoTaxa.value = get('t','aa'); el.dataInicio.value = get('d',''); el.seguroTaxa.value = get('fee',''); el.extraMensal.value = get('em','');
      // extras via EXn=valor@data
      const exParams = [...url.searchParams.entries()].filter(([k])=>/^ex\d+$/.test(k));
      extras.length = 0;
      exParams.forEach(([k,v])=>{
        const [valStr, dateStr] = v.split('@');
        const val = parseBRNumber(valStr);
        const [Y,M,D] = (dateStr||'').split('-').map(Number);
        if(val>0 && Y){
          const d = new Date(Date.UTC(Y,M-1,D));
          if(el.dataInicio.value){
            const [Y0,M0,D0] = el.dataInicio.value.split('-').map(Number); const d0 = new Date(Date.UTC(Y0,M0-1,D0));
            const mes = monthIndexFromDate(d0, d);
            if(mes>=1) extras.push({valor:val,data:d,mes});
          }
        }
      });
      renderExtrasChips();
    }

    function paramsAtuais(){
      const params = { p: el.principal.value, i: el.rate.value, n: el.periodo.value, sys: el.sistema.value, t: el.tipoTaxa.value, d: el.dataInicio.value, fee: el.seguroTaxa.value, em: el.extraMensal.value };
      extras.forEach((ex,idx)=>{ const y=ex.data.getUTCFullYear(), m=String(ex.data.getUTCMonth()+1).padStart(2,'0'), d=String(ex.data.getUTCDate()).padStart(2,'0'); params[`ex${idx+1}`] = `${fmtBRL.format(ex.valor)}@${y}-${m}-${d}`; });
      return params;
    }

    function calcular(){
      const principal = parseBRNumber(el.principal.value);
      const taxa = parseBRNumber(el.rate.value);
      const nMeses = parseInt(el.periodo.value||'0',10);
      const sistema = el.sistema.value;
      const tipoTaxa = el.tipoTaxa.value;
      const seguroTaxa = parseBRNumber(el.seguroTaxa.value);
      const extraMensal = parseBRNumber(el.extraMensal.value);
      let data0=null; if(el.dataInicio.value){ const [Y,M,D]=el.dataInicio.value.split('-').map(Number); if(Y&&M&&D) data0=new Date(Date.UTC(Y,M-1,D)); }
      if(!(principal>0)&&!(nMeses>0)) return;

      const iMes = (tipoTaxa==='aa')? mensalDeAnual(taxa) : (taxa/100);

      const extrasMes = [];
      if(data0){
        extras.forEach(ex=>{ extrasMes.push({ valor:ex.valor, mes:ex.mes, data:ex.data }); });
      }

      const {linhas,totalJuros,totalPago,mesesExecutados} = gerarCronograma({principal, iMes, nMeses, sistema, extras:extrasMes, extraMensal, seguroTaxa, data0});

      if(linhas.length){
        el.prestacaoIni.textContent = fmtBRL.format(linhas[0].prestacao);
        el.totalPago.textContent = fmtBRL.format(totalPago);
        el.totalJuros.textContent = fmtBRL.format(totalJuros);
        el.mesesQuitados.textContent = String(mesesExecutados);
      }

      el.tabela.innerHTML = '';
      for(const l of linhas){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${l.mes}</td>
          <td>${l.data}</td>
          <td>${fmtBRL.format(l.prestacao)}</td>
          <td>${fmtBRL.format(l.amortizacao)}</td>
          <td>${fmtBRL.format(l.juros)}</td>
          <td>${fmtBRL.format(l.taxas)}</td>
          <td>${fmtBRL.format(l.extra)}</td>
          <td>${fmtBRL.format(l.saldo)}</td>`;
        el.tabela.appendChild(tr);
      }

      desenharGraficoAnual(el.grafico, linhas, data0);

      el.baixarCsv.onclick = ()=>{ const blob=toCSV(linhas); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='amortizacao.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); };
      el.copiarLink.onclick = ()=> copiarLink(paramsAtuais());
      el.baixarPdf.onclick = ()=> exportarPDF();
    }

    el.form.addEventListener('submit', (e)=>{ e.preventDefault(); calcular(); });

    document.querySelector('#ano').textContent = String(new Date().getFullYear());
    lerDoQuery();
  </script>
</body>
</html>
